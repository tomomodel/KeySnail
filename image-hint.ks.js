// PLUGIN_INFO {{ =========================================================== //

var PLUGIN_INFO =
<KeySnailPlugin>
		<name>Image hint</name>
		<description>Operate image by hitting hints</description>
		<description lang="ja">ヒントを使って画像を操作</description>
		<version>0.0.8</version>
		<updateURL>https://raw.github.com/gist/899341/image-hint.ks.js</updateURL>
		<iconURL>data:image/gif;base64,R0lGODlhIAAgAPcAAAAAAP////z8/Pb09evq8PDw9PX19
		ubo7+fq8eTn7uXp8e3v8/Lz9fDx8+Xq8vL09/Hz9u/x9O7w80WT/lad/F+i/GKk/LDQ+r/Y+c3g+
		u/y9m6u/4m//7rW+djm+OLm683Y5OHq9Nvj7N/l7JPG/OPp73l8f+fs8fb3+PX29yhej0l3o3y//
		pnP/6PS/4qtzK7D1tbh6ztslVmKsoepxYmrx7PZ+arE2ae/1D56pkN8pkd+qkh+qGeUt26avXOcv
		I684KzM5Nvr98/d6N7o8OLr8tXd4+zx9fL2+evv8meew4vL+ZbU/53X/oOz04y62Yeyz425167d/
		7zj/6/Q58DY6cPb67rM2cTW42x1e9bj7Orz+fL4/Pb5+/Dz9WSq1UZ0kHG24GimznO03IXC53+uz
		IGvzIi10pHA3p3N6prI5ZnC26bL4rLZ8Zi4zbvh+KDA1Lba8MTo/rTU6a/N4LzZ68vn+Mfi88rk9
		MXc68ng7svh787j8LXFz9Di7Wuy3HfA6ILE6YzS+X253Z7c/5jN7KTd/pPE4ajg/5rN6aDQ66jS6
		qzX773n/7PZ7rfc8sLm+rnb78Dh9Mnm99Lv/8Hc673W5cvm9cvk887n9szh7dTo89fq9dvt99Xn8
		cHR2trq89bm79/v+Nvi5qPX8rLj/bzl+rvg887p99Hp9tLl79Pk7djm7fL09fDy8+rs7WeUqEpqe
		bzq/8Hs/8Xt/7nc7Mvv/8jh7c3h6rbp/9no7tHz/8Lv/sPc5PH09aXO2sz0/9X2/ylNVr3y/8X1/
		5rN1mujqs/6/8Tq7tb7/+P9/0Z5fGuPkaTNz9z///L///b394WxrZ3FwWOZkWGGfWebikxuYzloV
		0qFb0V4ZFOHc6bLuSdQOT15WFqKbzNhRO7v7v///vX19JmZmIiIh/j39Pr49v/+/f/8+snGxoaEh
		P79/f38/Lu6uvv7++vr69ra2srKyrm5uaioqJeXl4iIiIaGhoWFhXZ2dmVlZVRUVENDQzIyMiIiI
		hEREf///yH5BAEAAP8ALAAAAAAgACAAAAj/AP8BGEiwoMGDCAcKFMCwocOHECMyHBiRHcR1GCU+p
		Phw3YMk4sqJNActBQqGGSVydLjOS5cOFzBk8BCCgYEGNlO4WxdxZcN1rZBYmECUQgUWNlIJiTAgi
		S+eGwFcZPCARAsSGzYcJSTLUKlJRyRAdegTpRckcnLRmuKCwxJDthCxEFTE1diGZQWso/qrGK9dj
		aQ0KUWrEZMmRRrcnSi14wMIzLRJIzbsL61ZthohbnAOYl6PEKhd8xYNmTNnx4gB22XLgYTOUS8+i
		GCN27ds1ZoxmhUsGbBgCF57bszygYZYwoRdu9ZNmzEglJQpU7AANlniP42vUCFDBhgwy7Jh/5vW6
		xmCAuHO3S17LtyRBz946MixY8aMHrCmVduGwI+QLV20px5H64TDzhZ3zEEEAiPEgAUONPQwgw8vu
		CHNB3QcosYicdwhChcDFdgFJ5EwEockeWiyihYjIJBEAiDA4AYNNxxwwxlRPIGGImQ4MRAXmDjSh
		iSTTHLJJnPUoYcqK2ohQgkwwmCjGVCskcYYSlwxEChjBELKG3ZkkgonQQRBxRyV8OEJKKHEEMMIB
		NywxiJkiOHGKwEM5E4JlhxCBimmQJJJL1hgUYUVemiiiZqe+DFEFYV8UYYR5wQgAEXhhIOOBKxUQ
		soSgpBSCy6ssBKKKnvswQcnj4QhxhXmBPcA1UrspHdOOSVUkkgggJCxyC26hAIKHmR8AQc4mV4XU
		YHnoNOAH2wMMoYinZzyxxmjtDecAPLos88+8Qjwjj372NMOOeSkY0IWn9DRhzr1hAsPPvvoM8+lA
		MgzED/8vCMAPwT5M9A7At9jzjgA+PMOPAL3I7A9A0EMQLgCzDNQPvMILBXE/azTDwD2CIBPwu/oq
		7E8GvcrMUMrEwzAyAoLsE/C3xYkLj0RSxyuPhxJDDJDPPdjz9AS25PPyCDDM5A/AHPkcswVJzwPP
		TUDwPNA+/hLj8D+XN0QxCF/HTDOUsEjDzwOleyvRmnLI4+/AAiU0Nx0KxQQADs=</iconURL>
		<author mail="take.t.public@gmail.com" homepage="http://nakamzio.com/">T.T</author>
		<license document="http://www.opensource.org/licenses/mit-license.php">The MIT License</license>
		<license lang="ja">MIT ライセンス</license>
		<include>main</include>
		<detail lang="ja"><![CDATA[
=== 説明 ===

このプラグインは KeySnail 用 HaH プラグインの HoK と共に使用してください。

Image hint プラグインは HoK の拡張モードへ「ヒントを使って画像を保存する為のコマンド」を提供します。

すでに保存済みの同じ画像を避ける機能もあります。

==== 設定例 ====

>|javascript|
plugins.options["image-hint.save_key"]             = "p";
plugins.options["image-hint.save_continuaous_key"] = "P";
plugins.options["image-hint.save_dir"]             = "D:\\Pic";
plugins.options["image-hint.hint_query"]           = "img";
||<

フォルダ区切り文字は「\\」で記述してください。

=== Change Log ===

2013/05/01 (0.0.8) ファイル保存失敗の際にもう一回ループを追加（実際はあまり機能していないかもしれない。ただ、ファイルサイズが0のファイルに対しては上書きを行うようにした。）
2013/02/26 (0.0.7) Firefox18に対応(Privacy)
2012/01/14 (0.0.6) コード多少修正
2012/01/14 (0.0.3) バグ調査コード
2011/12/04 (0.0.2) 無限ループの回避
2011/10/24 (0.0.1) 改良

]]></detail>
</KeySnailPlugin>;

// }} ======================================================================= //

// Option
let pOptions = plugins.setupOptions("image-hint", {
  'save_key': {
    preset: 'p',
    description: M({
      en: "Key to save image (default: p)",
      ja: "画像を保存するキー (デフォルト: p)"
    })
  },
  'save_continuaous_key': {
    preset: 'P',
    description: M({
      en: "Key to save image to continuous (default: P)",
      ja: "続けて画像を保存するキー (デフォルト: P)"
    })
  },
  'save_dir': {
    preset: 'C:',
    description: M({
    	en: "save dir (default: C:)",
    	ja: "保存フォルダ (デフォルト: C:)"
    })
  },
  'hint_query': {
  	preset: 'img',
  	description: M({
  		en: "hint query (default: img)",
  		ja: "クエリ (デフォルト: img)"
  	})
  }
}, PLUGIN_INFO);

var optionsDefaultValue = {
		"save_key"						 : 'p',
		"save_continuaous_key" : 'P',
		"save_dir"						 : 'D:\\Pic',
		"hint_query"					 : 'img'
};

(function() {


let saveMode           = pOptions['save_key'];
let saveContinuousMode = pOptions['save_continuaous_key'];
let hintQuery          = pOptions['hint_query'];

/*
実際に保存するのはsaveImageRealの方
この関数はループを制御するためだけのもの
*/
function saveImage(elem){
	let loopCount    = 0; // ループカウント
	let maxLoopCount = 3; // 許容ループカウント
	while(loopCount < maxLoopCount){
	    let ret = saveImageReal(elem);
	    if(ret === -1){
	        // 恐らくファイル保存時にエラー
	        loopCount ++;
	    }else{
	        // 保存成功
	        return 0
	    }
    }
}

function saveImageReal(elem){
	let dir      = pOptions['save_dir'];
	let doc      = elem.ownerDocument;
	let url      = window.makeURLAbsolute(elem.baseURI, elem.src);
	var flg_same = false; // 同じ名前の画像が存在しているかどうか
	display.prettyPrint("Prepare to save file... => ", { timeout:10000, fade:100 });
	
	// リファラ
	var refererURI = null;
	try {
		refererURI = Cc['@mozilla.org/network/standard-url;1'].createInstance(Ci.nsIURI);
		refererURI.spec = doc.documentURI;
	} catch(e) { alert("referer = " + e) }
	 
	// キャッシュを利用する
	var cache = null;
	try {
		let sh = getWebNavigation().sessionHistory;
		cache = sh.getEntryAtIndex(sh.index, false).QueryInterface(Ci.nsISHEntry).postData;
	} catch (e) { alert("cache = " + e) }
	
	try {
		window.urlSecurityCheck(url, doc.nodePrincipal);
		// ダウンロードURL
		let downloadURL = Components.classes["@mozilla.org/network/io-service;1"].getService(Components.interfaces.nsIIOService).newURI(elem.src, null, null);

		// new persitence object
		var persist = Components.classes["@mozilla.org/embedding/browser/nsWebBrowserPersist;1"].createInstance(Components.interfaces.nsIWebBrowserPersist);
		persist.progressListener = {
			// implements nsIWebProgressListener
			onStateChange: function (aWebProgress, aRequest, aStateFlags, aStatus) {
				if (aStateFlags & Ci.nsIWebProgressListener.STATE_STOP) {
					// complete
					var cloneFile = localFile.clone();
					if (flg_same) {
						// 使いまわす変数
						var size = cloneFile.fileSize;
						let istream = Components.classes["@mozilla.org/network/file-input-stream;1"]
							.createInstance(Components.interfaces.nsIFileInputStream);
						istream.init(cloneFile, -1, -1, false);
						let bstream = Components.classes["@mozilla.org/binaryinputstream;1"]
							.createInstance(Components.interfaces.nsIBinaryInputStream);
						bstream.setInputStream(istream);
						var bytes = bstream.readBytes(bstream.available());
						istream.close();
						let flg_loop = true;
						var count = 0;
						
						while (flg_loop) {
							count ++;
							if (20 < count) {
								// 20回以上のループは一応停止
								display.prettyPrint("Stop to save image: Loop 20 count...", { timeout:10000, fade:100 });
								return;
							}
							if (checkFile(size, bytes, sameFile)) {
								// すでに保存しているファイルだった。
								display.prettyPrint("This file already saved => " + L(sameFile.path) + ", size = " + L(sameFile.fileSize), { timeout:10000, fade:100 });
								try {
									cloneFile.remove(false);
								} catch (e) {
									alert(e);
								}
								flg_loop = false;
							} else {
								// ファイル名+1のチェック
								let plusName = getPlusName(sameFile.leafName);
								sameFile = sameFile.parent;
								sameFile.append(plusName);
								if (!sameFile.exists()) {
									cloneFile.moveTo(sameFile.parent, sameFile.leafName);
									flg_loop = false;
									display.prettyPrint("save image => " + L(sameFile.path) + ", size = " + sameFile.fileSize, { timeout:10000, fade:100 });
								}
							}
						}
					} else {
						// display
						display.prettyPrint("save image => " + L(cloneFile.path) + ", size = " + cloneFile.fileSize, { timeout:10000, fade:100 });
						//display.showPopup("Save image",L(localFile.path));
					}
				}
			},
			onProgressChange: function (aWebProgress, aRequest,
										aCurSelfProgress, aMaxSelfProgress,
										aCurTotalProgress, aMaxTotalProgress) {},
			onLocationChange: function (aWebProgress, aRequest, aLocation) {},
			onStatusChange	: function (aWebProgress, aRequest, aStatus, aMessage) {},
			onSecurityChange: function (aWebProgress, aRequest, aState) {},
		};

		// with persist flags if desired
		const nsIWBP = Components.interfaces.nsIWebBrowserPersist;
		const flags = nsIWBP.PERSIST_FLAGS_REPLACE_EXISTING_FILES;
		persist.persistFlags = flags | nsIWBP.PERSIST_FLAGS_FROM_CACHE;
		
		// target file
		var localFile = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
		localFile.initWithPath(dir);
		// 
		if(!localFile.exists()){
			// if dir doesn't exist, alert error
			alert(M({
				ja: dir+" というディレクトリは存在しません。画像の保存を中断します。",
				en: dir+" doesn't exist. Cancel to save the image."
			}));
			return -1;
		}
		
		// ファイル名の決定
		let leafName = url.substring(url.lastIndexOf('/') + 1, url.length);
		// leafnameには?.*という文字列が追加されている場合があるので、?以下を取り除く
		leafName = leafName.match(/([^?]+)\?*/)[1];
		// なんか:が含まれている画像があったので、:を" "にする(Firefoxは:を" "にするハズ)
		leafName = leafName.replace(/\:/g, " ");
		localFile.append(leafName);
		
		// if file doesn't exist, create
		if(localFile.exists()) {
		    // ファイルサイズのチェック
		    if(localFile.fileSize === 0){
		        // 作っただけのファイルなのでチェック無視
		    }else{
			    // 同じ画像かの判断
			    flg_same = true;
			    var sameFile = localFile;
			    localFile = Components.classes["@mozilla.org/file/directory_service;1"]
				    .getService(Components.interfaces.nsIProperties)
				    .get("TmpD", Components.interfaces.nsIFile);
			    localFile.append(leafName);
			    localFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, 0664);
		    }
		} else {
		
			localFile.create(0x00,0644);
		}

        // privacy
        let privacyContext = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
                                   .getInterface(Components.interfaces.nsIWebNavigation)
                                   .QueryInterface(Components.interfaces.nsILoadContext);
		// save file to target
		display.prettyPrint("Now saving ...", { timeout:10000, fade:100 });
		
		persist.saveURI(downloadURL, cache, refererURI , null, null, localFile, privacyContext);
		// goto persist.progressListener.onStateChange
	}catch(e){
		alert(e);
		return -1;
	}
}

// Add HoK extend mode actions {{ =========================================== //

hook.addToHook('PluginLoaded', function () {
	if (!plugins.hok)
		return;

	var actions = [
		[saveMode, M({ja: "画像を保存", en: "Save image of the selected element"}),
		 function (e) saveImage(e), false, false],
		[saveContinuousMode, M({ja: "画像を連続保存", en: "Save image of the selected element to continuous"}),
		 function (e) saveImage(e), false, true]
	];

	function seekAction(aActions, aKey) {
		for (let i = 0; i < aActions.length; ++i)
		{
		if (aActions[i][0] === aKey)
			return i;
		}

		return -1;
	}

	actions.forEach(
		function ([aKey, aDesc, aFunc, autoFire, continuous]) {
		if (!aKey)
			return;

		let i   = seekAction(plugins.hok.actions, aKey);
		let row = [aKey, aDesc, aFunc, autoFire, continuous, hintQuery];

		if (i >= 0)
			plugins.hok.actions[i] = row;
		else
			plugins.hok.actions.push(row);
		}
	);
});

// }} ======================================================================= //


})();

function checkFile(size, bytes, destFile) {
	if (size === destFile.fileSize) {
		// バイト列で比較
		let istream = Components.classes["@mozilla.org/network/file-input-stream;1"]
			.createInstance(Components.interfaces.nsIFileInputStream);
		istream.init(destFile, -1, -1, false);
		let bstream = Components.classes["@mozilla.org/binaryinputstream;1"]
			.createInstance(Components.interfaces.nsIBinaryInputStream);
		bstream.setInputStream(istream);
		let destBytes = bstream.readBytes(bstream.available());
		istream.close();
		
		if (bytes === destBytes) {
			return true;
		} else {
			return false;
		}
	} else {
		return false;
	}
}

function getPlusName(fileName) {
	let reg = fileName.match(/(.*)(\.[^\.]*?)$/i);
	let leafName;
	let ext;
	if (!reg) {
		leafName = fileName;
		ext = "";
	} else {
		leafName = reg[1];
		ext = reg[2] || "";
	}
	let num = leafName.match(/-([0-9]*)$/i);
	let plusName;
	if (!num) {
		// ファイル名に/-数字$/が含まれていない
		plusName = leafName + "-1";
	} else {
		let plus = Number(num[1])+1;
		plusName = leafName.replace(/-([0-9]*)$/i, "");
		plusName += "-" + String(plus);
	}
	return returnName = plusName + ext;
}